# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¢–æ–∫—Å–∏–∫ –ë–æ—Ç–∞

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–¢–æ–∫—Å–∏–∫ –±–æ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ –º–æ–Ω–æ–ª–∏—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Python —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Telegram Bot API                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  aiogram Dispatcher                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ              Message Handlers                           ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Text messages    ‚Ä¢ Commands                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Photos/Images    ‚Ä¢ Admin functions                   ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Core Logic                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Person Profile System  ‚Ä¢ Relationship Analysis      ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Chat Style Analysis    ‚Ä¢ Memory Management          ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Context Building       ‚Ä¢ Auto-activity Detection    ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                External Services                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ      Groq API          ‚îÇ        SQLite DB              ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Text Generation     ‚îÇ  ‚Ä¢ User profiles               ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Vision Models       ‚îÇ  ‚Ä¢ Chat history                ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Multiple fallbacks  ‚îÇ  ‚Ä¢ Relationships               ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Message Processing Pipeline

```python
Telegram Message ‚Üí aiogram ‚Üí Handler Selection ‚Üí Context Building ‚Üí LLM ‚Üí Response
                                    ‚Üì
                              Profile Updates ‚Üí Memory Storage
```

**–≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
2. **–ö–æ–Ω—Ç–µ–∫—Å—Ç**: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å—Ç–æ—Ä–∏–∏, —Å—Ç–∏–ª—è —á–∞—Ç–∞
3. **–û–±–æ–≥–∞—â–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π –∏ –ø–∞–º—è—Ç–∏
4. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è**: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ LLM —Å —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
5. **–ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞**: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é

### 2. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```python
DEFAULT_PROFILE = {
    "names": [],                    # –ò–º–µ–Ω–∞ –∏ –∞–ª–∏–∞—Å—ã
    "aliases": [],                  # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏–º–µ–Ω–∞
    "address_terms": [],            # –°–ø–æ—Å–æ–±—ã –æ–±—Ä–∞—â–µ–Ω–∏—è
    "to_bot_terms": [],            # –ö–∞–∫ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –±–æ—Ç—É
    "likes": [],                   # –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
    "dislikes": [],                # –ê–Ω—Ç–∏–ø–∞—Ç–∏–∏
    "notes": [],                   # –ó–∞–º–µ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    "spice": 1,                    # –£—Ä–æ–≤–µ–Ω—å —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏ (0-3)
    "to_bot_tone": 0.0,           # –û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –±–æ—Ç—É (-1 –¥–æ +1)
    "username": "",               # Telegram username
    "display_name": ""            # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
}
```

**–ú–µ—Ö–∞–Ω–∏–∑–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–∫—Ä–∞—Å–∫–∏
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫

### 3. –ê–Ω–∞–ª–∏–∑ –º–µ–∂–ª–∏—á–Ω–æ—Å—Ç–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π

–°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –ø–æ —Å—Ö–µ–º–µ `A ‚Üí B`:

```python
relationship = {
    "score": float,        # –°–∏–ª–∞ —Å–≤—è–∑–∏ (-1 –¥–æ +1)
    "tone": float,         # –¢–æ–Ω –æ–±—â–µ–Ω–∏—è (-1 –¥–æ +1) 
    "addr": [],           # –ò—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π
    "last_ts": float      # –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
}
```

**–§–∞–∫—Ç–æ—Ä—ã –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏—è:**
- –ß–∞—Å—Ç–æ—Ç–∞ —Ä–µ–ø–ª–∞–µ–≤ –∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π
- –¢–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π/–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω –∏ –æ–±—Ä–∞—â–µ–Ω–∏–π
- –≠–º–æ–¥–∑–∏ –∏ —Ä–µ–∞–∫—Ü–∏–∏

### 4. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å —á–∞—Ç–∞

–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ —Å—Ç–∏–ª—é –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞:

```python
style_profile = {
    "avg_msg_len": float,      # –°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    "profanity_rate": float,   # –ß–∞—Å—Ç–æ—Ç–∞ –º–∞—Ç–∞
    "emoji_rate": float,       # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç–º–æ–¥–∑–∏
    "caps_rate": float,        # –ß–∞—Å—Ç–æ—Ç–∞ CAPS
    "question_rate": float,    # –ß–∞—Å—Ç–æ—Ç–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
    "slang_terms": [],         # –ú–µ—Å—Ç–Ω—ã–π —Å–ª–µ–Ω–≥
    "common_topics": [],       # –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã
    "activity_pattern": {},    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
}
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü

```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
CREATE TABLE settings (
    id INTEGER PRIMARY KEY CHECK (id=1),
    system_prompt TEXT NOT NULL,
    model TEXT NOT NULL
);

-- –ò—Å—Ç–æ—Ä–∏—è –ª–∏—á–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
CREATE TABLE history (
    user_id TEXT NOT NULL,
    role TEXT NOT NULL,           -- 'user' –∏–ª–∏ 'assistant'
    content TEXT NOT NULL,
    ts REAL NOT NULL
);

-- –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤
CREATE TABLE chat_history (
    chat_id TEXT NOT NULL,
    role TEXT NOT NULL,
    content TEXT NOT NULL,
    ts REAL NOT NULL,
    user_id TEXT
);

-- –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE person_profile (
    chat_id TEXT NOT NULL,
    user_id TEXT NOT NULL,
    profile_json TEXT NOT NULL,   -- JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è
    updated_ts REAL NOT NULL,
    PRIMARY KEY (chat_id, user_id)
);

-- –ú–µ–∂–ª–∏—á–Ω–æ—Å—Ç–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è
CREATE TABLE relationship_profile (
    chat_id TEXT NOT NULL,
    user_id_a TEXT NOT NULL,      -- –û—Ç –∫–æ–≥–æ
    user_id_b TEXT NOT NULL,      -- –ö –∫–æ–º—É
    score REAL NOT NULL,          -- –°–∏–ª–∞ —Å–≤—è–∑–∏
    tone REAL NOT NULL,           -- –¢–æ–Ω –æ—Ç–Ω–æ—à–µ–Ω–∏–π
    addr_json TEXT,               -- JSON —Å –∏—Å—Ç–æ—Ä–∏–µ–π –æ–±—Ä–∞—â–µ–Ω–∏–π
    last_ts REAL NOT NULL,
    PRIMARY KEY (chat_id, user_id_a, user_id_b)
);

-- –°—Ç–∏–ª–µ–≤—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ —á–∞—Ç–æ–≤
CREATE TABLE chat_style (
    chat_id TEXT PRIMARY KEY,
    style_json TEXT NOT NULL,     -- JSON —Å–æ —Å—Ç–∏–ª–µ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏
    updated_ts REAL NOT NULL
);

-- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
CREATE TABLE reminders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id TEXT NOT NULL,
    user_id TEXT NOT NULL,
    text TEXT NOT NULL,
    due_ts REAL NOT NULL,
    created_ts REAL NOT NULL
);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –ø–∞–º—è—Ç—å
CREATE TABLE user_memory (
    user_id TEXT NOT NULL,
    value TEXT NOT NULL,
    ts REAL NOT NULL
);

-- –ü–∞–º—è—Ç—å —á–∞—Ç–æ–≤
CREATE TABLE chat_memory (
    chat_id TEXT NOT NULL,
    value TEXT NOT NULL,
    ts REAL NOT NULL
);
```

## –ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏ –ª–æ–≥–∏–∫–∞

### 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞

```python
def should_respond(message):
    if message.chat.type == "private":
        return True
    
    if was_called(message):  # –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±–æ—Ç–∞
        return True
        
    if should_autochime(message.chat.id):  # –°–ª—É—á–∞–π–Ω—ã–π –≤–±—Ä–æ—Å
        return "autochime"
        
    return False
```

### 2. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è LLM

```python
def build_context(user_id, message):
    context = []
    
    # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    system_prompt = get_system_prompt()
    
    # –°—Ç–∏–ª–µ–≤—ã–µ –¥–æ–±–∞–≤–∫–∏
    if is_group_chat:
        system_prompt += get_style_addon(chat_id)
        system_prompt += get_person_addon(chat_id, user_id)
        system_prompt += get_social_addon(chat_id, user_id, reply_to)
    
    # –ü–∞–º—è—Ç—å
    user_facts = get_user_memory(user_id)
    chat_facts = get_chat_memory(chat_id)
    system_prompt += format_memory(user_facts, chat_facts)
    
    # –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
    recent_history = get_recent_history(user_id, limit=20)
    
    return [{"role": "system", "content": system_prompt}] + recent_history
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

**–î–µ—Ç–µ–∫—Ç–æ—Ä —Ç–∏—à–∏–Ω—ã:**
```python
async def idle_watcher():
    while True:
        chats = get_active_chats()
        for chat_id, last_activity in chats:
            silence_minutes = (now() - last_activity) / 60
            
            if silence_minutes > IDLE_THRESHOLD:
                if not in_cooldown(chat_id):
                    await generate_idle_message(chat_id)
```

**–°–ª—É—á–∞–π–Ω—ã–µ –≤–±—Ä–æ—Å—ã:**
```python
def should_autochime(chat_id):
    if random.random() < AUTO_CHIME_PROB:
        if not in_cooldown(chat_id, AUTO_CHIME_COOLDOWN):
            return True
    return False
```

## –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

```
Message ‚Üí Profile Update ‚Üí Relationship Update ‚Üí Context Building ‚Üí LLM ‚Üí Response
    ‚Üì              ‚Üì                ‚Üì               ‚Üì            ‚Üì        ‚Üì
 Tone Analysis  Social Graph   Memory Retrieval  Prompt Build  Filter  History
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

```
Image ‚Üí File Download ‚Üí Vision API ‚Üí Context Analysis ‚Üí Response Generation
   ‚Üì         ‚Üì            ‚Üì             ‚Üì                     ‚Üì
Caption    URL Build   Multi-model   Image Memory         Filter
```

### 3. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```
Admin Command ‚Üí Permission Check ‚Üí Action Execute ‚Üí State Update ‚Üí Response
      ‚Üì              ‚Üì                ‚Üì              ‚Üì           ‚Üì
   Parse Args    Check Admin ID   Database Op   Cache Update  Confirm
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:

**–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```bash
TELEGRAM_BOT_TOKEN         # –¢–æ–∫–µ–Ω –±–æ—Ç–∞
GROQ_API_KEY              # API –∫–ª—é—á Groq
GROQ_MODEL                # –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å
DEFAULT_SYSTEM_PROMPT     # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
```

**–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```bash
SPICE_LEVEL               # –£—Ä–æ–≤–µ–Ω—å —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏ (0-3)
AUTO_CHIME_PROB           # –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤–±—Ä–æ—Å–∞ (0-1)
AUTO_CHIME_COOLDOWN       # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –≤–±—Ä–æ—Å–∞–º–∏ (—Å–µ–∫)
NAME_KEYWORDS             # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
```

**–í—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```bash
IDLE_CHIME_MINUTES        # –ú–∏–Ω—É—Ç—ã —Ç–∏—à–∏–Ω—ã –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
QUIET_HOURS_START         # –ù–∞—á–∞–ª–æ —Ç–∏—Ö–∏—Ö —á–∞—Å–æ–≤
QUIET_HOURS_END           # –ö–æ–Ω–µ—Ü —Ç–∏—Ö–∏—Ö —á–∞—Å–æ–≤
TOPIC_DECAY_MINUTES       # –í—Ä–µ–º—è –∑–∞–±—ã–≤–∞–Ω–∏—è —Ç–µ–º—ã
```

**–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```bash
HISTORY_TURNS             # –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏
STYLE_CACHE_TTL_MIN       # TTL –∫—ç—à–∞ —Å—Ç–∏–ª—è (–º–∏–Ω)
STYLE_RETRAIN_MIN_MESSAGES # –ú–∏–Ω. —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∏–ª—è
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –£–∑–∫–∏–µ –º–µ—Å—Ç–∞:
1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: SQLite –Ω–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞ –¥–ª—è concurrent –¥–æ—Å—Ç—É–ø–∞
2. **–ü–∞–º—è—Ç—å**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. **LLM –∑–∞–ø—Ä–æ—Å—ã**: –ù–µ—Ç –±–∞—Ç—á–∏–Ω–≥–∞ –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Ö–æ–∂–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–§–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
1. **Connection pooling** –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
2. **Redis** –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–µ—Å—Å–∏–π
3. **Async file operations** –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
4. **LLM response caching** –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
5. **Database indexing** –¥–ª—è —á–∞—Å—Ç—ã—Ö queries

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –¢–µ–∫—É—â–∏–µ –º–µ—Ä—ã:
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–∞—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏:
- SQL injection (—á–∞—Å—Ç–∏—á–Ω–æ –∑–∞—â–∏—â–µ–Ω–æ parametrized queries)
- Memory exhaustion –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —á–∞—Ç–∞—Ö
- Rate limiting –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- –õ–æ–≥–∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
- –í–Ω–µ–¥—Ä–∏—Ç—å rate limiting
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
- –ê—É–¥–∏—Ç –ª–æ–≥–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
- Sandbox –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–¥–∞
- OWASP security headers –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –¢–µ–∫—É—â–µ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
```python
logging.basicConfig(level=logging.INFO)
log = logging.getLogger("bot")
```

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ LLM API
- –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- –†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- Memory usage

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
- SQLite browser –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
- Telegram Bot API logs
- Python profiler –¥–ª—è –ø–æ–∏—Å–∫–∞ bottlenecks
- Custom debug commands –¥–ª—è –∞–¥–º–∏–Ω–æ–≤